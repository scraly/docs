# Installing Keycloak on OVHcloud Managed Kubernetes

## Goals of this tutorial

+ Be able to configure a working Keycloak deployment over the top of a Managed Kubernetes Service provided by OVHcloud
+ Configure the `OpenIdConnect` flags available for the `kube-apiserver` component of a Managed Kubernetes Service through the OVHcloud APIv6
+ Be able to use the `kubectl` command line with the Keycloak OpenIdConnect provider configured
+ Be able to use the `kubectl` command line with Keycloak and a token generated by GitHub configured as `Identity Provider`

## What is OIDC

OIDC stands for “__OpenID Connect__”.  
It is an authentication protocol which allows verifying user identity when a user is trying to access a protected HTTPs endpoint.

## Dependencies and requirements

### A cert-manager to enable HTTPS connexion through keycloak

* Helm chart description: [cert-manager Helm chart](https://artifacthub.io/packages/helm/cert-manager/cert-manager)
* Used Helm Chart for the deployment: `jetstack/cert-manager`

How to add the `cert-manager` Helm repo:

```bash
helm repo add jetstack https://charts.jetstack.io
helm repo update
```

Then install the `cert-manager` Helm chart:

```bash
helm install ovh-cert-lab jetstack/cert-manager --namespace cert-manager --create-namespace --version v1.5.0 -f files/01-cert-manager/01-cert-manager-definition.yaml
```

Then, we will create an `ACME ClusterIssuer` used by the `cert-manager` operator to requesting certificates from ACME servers, including from Let’s Encrypt.

During this lab, we will use the Let's Encrypt `staging` environment to generate all our testing certificates.  
But a `YAML` manifest is also available to use the Let's Encrypt `production` environment.

```bash
kubectl --namespace cert-manager apply -f files/01-cert-manager/02-acme-staging-issuer-http01.yaml
```

### An Ingress Nginx to expose Keycloak

* Helm chart description: [ingress-nginx Helm chart](https://artifacthub.io/packages/helm/ingress-nginx/ingress-nginx)
* Used Helm Chart for the deployment: `ingress-nginx/ingress-nginx`

How to add `ingress-nginx` Helm repository:

```bash
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
```

Then install the `nginx-ingress` controller:

```bash
helm install ovh-ingress-lab ingress-nginx/ingress-nginx --namespace ingress-nginx --create-namespace --version 3.35.0
```

If you need to customize your `ingress-nginx` configuration, please refer to the following documentation: [ingress-nginx values](https://github.com/kubernetes/ingress-nginx/blob/main/charts/ingress-nginx/values.yaml)

__For information:__  
Installing this `ingress-nginx` controller will order a LoadBalancer provides by OVHcloud *(this load balancer will be monthly billed)*.  

To check if the `LoadBalancer` is up and running, execute the following CLI in a console:

```bash
kubectl --namespace ingress-nginx get services -o wide ingress-nginx-controller
```

Once your LoadBalancer is up and running, get its IP address to configure your domain name zone:

```bash
kubectl -n ingress-nginx get service ovh-ingress-lab-ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}{"\n"}'
```

In my case, the `nslookup` result of my domain entry shows the following information:

```bash
➱ nslookup keycloak.lab.ovh
Server:         10.15.25.129
Address:        10.15.25.129#53

Non-authoritative answer:
Name:   keycloak.lab.ovh
Address: 51.90.64.27 # where this IP address is the IP used by my Kubernetes service of `LoadBalancer` type
```

I let you configure your domain and come back here for the next step of this tutorial :)

## How to configure and deploy the Codecentric Keycloak provider

* Helm chart description: [codecentric Keycloak Helm chart](https://artifacthub.io/packages/helm/codecentric/keycloak)
* Used Helm Chart for the deployment: `codecentric/keycloak`

__For information:__  
A `PersitentVolume` will be created to host PostgreSQL data.  
This `PersitentVolume` will be provided through the Cinder storage class which is the default storage class used by Managed Kubernetes Service at OVHcloud *(this volume will be billed)*.

### Keycloak installation

How to add the `codeCentric` repository:

```bash
helm repo add codecentric https://codecentric.github.io/helm-charts
helm repo update
```

Then install the `codecentric/keycloak` helm chart:

```bash
helm install ovh-keycloak-lab codecentric/keycloak -n keycloak --create-namespace --version 14.0.1 -f files/02-keycloak/01-keycloak-definition.yaml
```

Check if the Keycloak `statefulSet` is `Ready`:

```bash
kubectl -n keycloak get statefulsets.apps -o wide
```

If yes, we could configure the ingress route required to expose Keycloak on the Internet:

```bash
kubectl apply -f files/02-keycloak/02-nginx-ingress-definition.yaml
```

### Keycloak configuration

If you are reading this chapter, it indicates that your Keycloak is already up and running.  
Let's go and open the Keycloak Web console: `https://keycloak.your-domain-name.tld/`  
Login with the username and password configured in the `02-keycloak/01-keycloak-definition.yaml` file.

#### Create a REALM

A __realm__ in Keycloak is the equivalent of a tenant or a namespace. It allows creating isolated groups of applications and users.  
By default, there is a single realm in Keycloak called `Master`. This is dedicated to manage Keycloak and should not be used for your own applications.

Let's create a realm dedicated to our lab:

1) Open the Keycloak Admin console (https://keycloak.your-domain-name.tld/)
2) With your mouse display the dropdown menu in the top-left corner where it indicates `Master`, then click on `Add realm`
3) Fill in the form with this name: `ovh-lab-k8s-oidc-authentication`, then click on the `Create` button

#### Create a CLIENT

A __client__ in Keycloak is an entity that can request a Keycloak server to authenticate a user.

1) From the previously created realm, click on the left-hand menu `Clients` under the `Configure` category
2) Click on `Create` in the top-right corner of the table
3) Fill in the form with the following parameter:

```text
Client ID: k8s-oidc-auth
Client Protocol: openid-connect
Root URL: https: https://keycloak.your-domain-name.tld/
```

4) Then click on the `Save` button
5) Find the `Access Type` field and set its value to `confidential` to require a secret to initiate login protocol and save the change to display the `Credentials` tab
6) Find the `Valid Redirect URIs` field and set the following value: `*`.
7) Find the `Admin URL` and `Web Origins` fields and set their values to your defined domain name.  
In my example: `https://keycloak.jlecorre.ovh/`. __\/!\ Be careful to use the HTTPS schema! /!\\__
8) Save your changes

#### Create a USER

1) From the previously created realm, click on the left-hand menu `Users` under the `Manage` category
2) Click on `Add user` in the top-right corner of the table
3) Fill in the form. Only the `Username` field is required, it's enough for this lab.
4) Then click on the `Save` button

The first user connection required an initial password, so let's create it:

1) Click on the `Credentials` tab
2) Fill in the `Set Password` form
3) Disable the `Temporary` flag to prevent having to update password on first login
4) Then click on the `Set Password` button

In my example, I created the following user:

```text
Username: ovhcloud-keycloak-lab
Password: ovhcloud-keycloak-lab-awesome-password
```

### Kube-apiserver configuration

Some endpoints, to operate your Managed Kubernetes Service provided by OVHcloud, are available through the APIv6.  
In our case, we will configure two required flags associated to the `openIdConnect` configuration.

Go to the `APIv6 console`: [api.ovh.com](https://api.ovh.com/console/) and log in.  
Then, find the endpoints to use to update the `openIdConnect` configuration of your Managed Kubernetes Service.

#### openIdConnect endpoints exposed by the OVHcloud API

* Get `openIdConnect` integration parameters configured on the managed `kube-apiserver`:

```text
GET /kube/service_id/openIdConnect
```

* Configure `openIdConnect` flags on the managed `kube-apiserver`:

```text
POST /kube/service_id/openIdConnect
{
"issuerUrl": "",
"clientId": ""
}
```

* Update `openIdConnect` parameters and reconfigure the managed `kube-apiserver`:

```text
PUT /kube/service_id/openIdConnect
{
"issuerUrl": "",
"clientId": ""
}
```

* Remove `openIdConnect` integration parameters from the managed `kube-apiserver`:

```text
DEL /kube/service_id/openIdConnect
```

__Where:__

* `{serviceName}` is your Openstack tenant ID
* `{kubeId}` is your cluster ID

#### openIdConnect integration configuration

Here, we will execute the `POST` query to add a new `openIdConnect` configuration to our cluster with the following values:

```
serviceName: ${your-openstack-tenant-id}
kubeId: ${your-managed-kubernetes-id}
# the client named previously defined: `k8s-oidc-auth` in my example
clientId: k8s-oidc-auth
# the URL to access to my previsouly defined realm: https://${your-configured-root-url}/auth/realms/${your-configured-realm-name}
# In my example: `https://keycloak.jlecorre.ovh/auth/realms/k8s-oidc-authentication`
issuerUrl: https://keycloak.jlecorre.ovh/auth/realms/k8s-oidc-authentication
```

Then execute the query and wait a few minutes during the reconfiguration of the `kube-apiserver` of your Managed Kubernetes Service.

During the reconfiguration step, if it's not already done, you can install the `kubectl` plugin manager named [Krew](https://krew.sigs.k8s.io/).  
Then, install the [kubelogin plugin](https://github.com/int128/kubelogin) to extend the capacity of the `kubectl` command line and easily configure your environment to be able to use your Keycloak server.

```bash
kubectl krew install oidc-login
```

Once `kubelogin` installed, go back to the Keycloak webinterface to get your client secret.  
You can find this information here:

- Click on the `Clients` menu on the left column
- Click on your previously created client (`k8s-oidc-auth` in my example)
- Go to the `Credentials` tab ang get your `secret`

Then, customize the following command line with your information and execute it to be able to:

- log in to your Keycloak provider through your browser
- generate a token from it
- configure your Kubectl context to access to Kubernetes APIs with the freshly generated token

Here with the information related to my example:

```bash
kubectl oidc-login setup \
--oidc-issuer-url="https://keycloak.jlecorre.ovh/auth/realms/k8s-oidc-authentication" \
--oidc-client-id="k8s-oidc-auth" \
--oidc-client-secret="f6ed439e-2dcc-4812-bbff-282cf10bef59"
```

Your browser will display an authentication page to your Keycloak server.  
Here log in with the credentials defined during the `user creation` step of this tutorial.

Once, the authentication succeeded, you can close your browser tab on go back to your console where a message have been displayed.

The `kubelogin` plugin has given you some instructions to follow to finalize the configuration of your Kubectl environment.

Now, you must create a `ClusterRoleBinding` (step 3 of the kubelogin output):

```bash
# example of output generated on my environment, please customize it with your information
kubectl create clusterrolebinding oidc-cluster-admin --clusterrole=cluster-admin --user='https://keycloak.jlecorre.ovh/auth/realms/k8s-oidc-authentication#fdb220d7-ad75-4486-9866-b8f59bd6e661'
```

You can ignore the `step 4` if you have already configured the `kube-apiserver` through the OVHcloud APIv6.  
Then, configure your `kubeconfig` (step 5 of the `kubelogin` output):

```bash
# example of output generated on my environment, please customize it with your information
kubectl config set-credentials oidc \
  --exec-api-version=client.authentication.k8s.io/v1beta1 \
  --exec-command=kubectl \
  --exec-arg=oidc-login \
  --exec-arg=get-token \
  --exec-arg=--oidc-issuer-url=https://keycloak.jlecorre.ovh/auth/realms/k8s-oidc-authentication \
  --exec-arg=--oidc-client-id=k8s-oidc-auth \
  --exec-arg=--oidc-client-secret="f6ed439e-2dcc-4812-bbff-282cf10bef59"
```

And verify your cluster access (step 6 of the `kubelogin` output):

```bash
kubectl --user=oidc get nodes
```

If you could see the nodes available in to your Managed Kubernetes Service, congrats your Keycloak is up and running!

#### Configure GitHub as an identity provider in Keycloak

Here, we will configure GitHub as an `Identity Provider` in our Keycloak server hosted in a Managed Kubernetes Service.

#### GitHub configuration

1) Once log in your GitHub account, go to the [Developers settings](https://github.com/settings/developers)
2) Click on the `OAuth Apps` menu, then click on `Register a new application`
3) Fulfil the following fields:

```text
Application name: ovhcloud-keycloak-lab
Homepage URL: ${your-keycloak-url} # Im my example: https://keycloak.jlecorre.ovh/
Application description: An awesome description like `OVHcloud keycloak lab`
Authorization callback URL: anything you want, we will come back to update this filed if few minutes!
```

4) Then click on the `Register application` button
5) Click on `Generate a new client secret` and keep the secret somewhere, we will use it in a few minutes

#### Keycloak configuration

1) Go back to your Keycloak instance
2) In the `k8s-oidc-authentication` realm, under the `Configure` menu, click on the `Identity Provider` link located in the left column
3) Select the `Social > Github` provider
4) Fulfil the following fields:

```text
Client ID: use the clientId given by Github. In my example: `5vabf3c16570ec9d3da7`
Client Secret: use the secret given by Github. In my example: `92dd205300b0186597395543cfc0fa3c9927aab3`
```

5) Then save your changes
6) In the `k8s-oidc-authentication` realm, under the `Configure` menu, click on the `Clients` link located in the left column
7) Then, click on `Create` in the top-right corner of the table
8) Fulfill the following parameters:

```text
Client ID: k8s-github-auth
Client Protocol: openid-connect
Root URL: https: https://keycloak.your-domain-name.tld/
```

9) Find the `Access Type` field and set its value to `confidential` to require a secret to initiate login protocol and save the change to display the `Credentials` tab
10) Find the `Valid Redirect URIs` field and set the following value: `*`.
11) Find the `Admin URL` and `Web Origins` fields and set their values to your defined domain name.  
In my example: `https://keycloak.jlecorre.ovh/`. __\/!\ Be careful to use the HTTPS schema! /!\\__
12) Save your changes

#### Kube-apiserver configuration

Now, it's the time to update the `openIdConnect` parameters of our `kube-apiserver` component.  
Through the [OVHcloud APIv6](https://api.ovh.com/console/#/cloud/project/%7BserviceName%7D/kube/%7BkubeId%7D/openIdConnect#PUT), find the endpoint to use to update the OIDC configuration of your Managed Kubernetes Service.

We will use the `PUT` query to update the `clientId` parameter with the new one created to use GitHub as an `Indentity Provider` for the K8s cluster.
In my example:

```text
{
    issuerUrl: https://keycloak.jlecorre.ovh/auth/realms/k8s-oidc-authentication
    clientId: "k8s-github-auth"
}
```

#### Finalize the configuration

Before to configure the cluster to get an identity from GitHub, we must update the `Authorization callback URL` previously configured in the GitHub OAuth application.

1) Go to the GitHub provider configured in Keycloak under the `Configure > Identity Provider` menu
2) Find the `github` provider then click on the `Edit` button
3) Copy the content of the `Redirect URI`
4) Go back to the previously created `ovhcloud-keycloak-lab` OAuth application in GitHub
5) Paste the `Redirect URI` content in the `Authorization callback URL`
6) Then update the application

#### kubelogin configuration

As already done in this tutorial, we will use the [kubelogin plugin](https://github.com/int128/kubelogin) to configure the Managed Kubernetes Service to use our OIDC provider.

With the following information found in the Keycloak web interface, customize your command line to execute the `kubelogin` plugin through `kubectl`:

* The OIDC issuer URL
* The OIDC client ID associated to the `k8s-github-auth` client created in Keycloak
* The OIDC client secret associated to the `k8s-github-auth` client created in Keycloak

Here with the information related to my example:

```bash
kubectl oidc-login setup \
--oidc-issuer-url="https://keycloak.jlecorre.ovh/auth/realms/k8s-oidc-authentication" \
--oidc-client-id="k8s-github-auth" \
--oidc-client-secret="0de2a792-38c1-488f-8f54-f2afdb97f5d6"
```

Your browser will display an authentication page to your Keycloak server.  
Here log in using the `Github` button available under the form `Sign in to your account`.  
You will be redirected to the GitHub website to authorize your GitHub account to log in to the OAuth application created earlier.  
Once, authenticated, you will be redirected to Keycloak to update your account information.  
Fulfil the required information then click on the `Submit` button.  
If your identity has been provided by GitHub, you will be redirected to a page displaying: `Authenticated`

To finalize the configuration executed the instructions shown by `kubelogin`:

1) Cluster role binding creation

```text
# In my example
kubectl create clusterrolebinding oidc-cluster-admin --clusterrole=cluster-admin --user='https://keycloak.jlecorre.ovh/auth/realms/k8s-oidc-authentication#1851f838-f493-410e-aafe-d20291b7ab9b'
```

2) Creation of the required credentials

```text
# In my example
kubectl config set-credentials oidc \
--exec-api-version=client.authentication.k8s.io/v1beta1 \
--exec-command=kubectl \
--exec-arg=oidc-login \
--exec-arg=get-token \
--exec-arg=--oidc-issuer-url=https://keycloak.jlecorre.ovh/auth/realms/k8s-oidc-authentication \
--exec-arg=--oidc-client-id=k8s-github-auth \
--exec-arg=--oidc-client-secret=0de2a792-38c1-488f-8f54-f2afdb97f5d6
```

3) Ignore the `step 4` has we have already configured the `kube-apiserver` through the OVHcloud APIv6
4) Test your configuration

```text
kubectl --user=oidc get nodes
```

If you can see your Kubernetes nodes list, your GitHub identity provider is properly working.  
Enjoy!

### Upgrade the keycloak deployment if needed

```bash
helm upgrade ovhcloud-keycloak-lab codecentric/keycloak -n keycloak -f files/02-keycloak/01-keycloak-definition.yaml
```

### Rollout restarts the Keycloak statefulsets if needed

```bash
kubectl -n keycloak rollout restart statefulset ovh-keycloak-lab
```

### Various troubleshooting

- If the `cert-manager` namespace is stuck in deleting state, see the following documentation: [namespace-stuck-in-terminating-state](https://cert-manager.io/docs/installation/helm/#namespace-stuck-in-terminating-state)

# Useful resources

https://www.keycloak.org/documentation
https://artifacthub.io/packages/helm/codecentric/keycloak
https://cert-manager.io/docs/usage/ingress/
https://www.keycloak.org/getting-started/getting-started-kube
https://kubernetes.io/docs/reference/access-authn-authz/authentication/#option-1-oidc-authenticator
